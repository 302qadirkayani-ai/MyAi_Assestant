<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEGIS v12 - Voice & Plugin System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg-deep: #020617;
            --color-accent-neon: #0ea5e9;
            --color-glass-dark: rgba(22, 28, 48, 0.6);
        }

        body {
            background-color: var(--color-bg-deep);
            background-image: radial-gradient(circle at 50% 10%, #1e40af33, transparent 70%);
            font-family: 'Montserrat', sans-serif;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--color-glass-dark);
            backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.47);
        }

        .neon-text {
            color: var(--color-accent-neon);
            text-shadow: 0 0 5px var(--color-accent-neon);
        }

        .diag-good { color: #10b981; }
        .diag-warn { color: #fbbf24; }
        .diag-critical { color: #ef4444; }

        .input-cyber {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(14, 165, 233, 0.3);
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        .input-cyber:focus {
            outline: none;
            border-color: var(--color-accent-neon);
            box-shadow: 0 0 8px rgba(14, 165, 233, 0.6);
        }

        .rtl-font {
            font-family: 'Noto Nastaliq Urdu', 'Cairo', 'Montserrat', sans-serif;
        }

        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-modal.active {
            display: flex;
        }

        .listening {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Permission Modal -->
    <div id="permissionModal" class="permission-modal">
        <div class="glass-panel p-8 max-w-2xl">
            <h2 class="text-2xl font-bold mb-4 neon-text">üîê Permission Required</h2>
            <div id="permissionContent" class="mb-6"></div>
            <div class="flex space-x-4">
                <button onclick="AEGIS.approvePermission()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold">
                    ‚úÖ Allow
                </button>
                <button onclick="AEGIS.denyPermission()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold">
                    ‚ùå Deny
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-[95vh]">

        <div class="lg:col-span-3 flex flex-col space-y-6">

            <header class="flex flex-col md:flex-row justify-between items-start md:items-center p-4 glass-panel">
                <h1 class="text-3xl font-bold tracking-wider neon-text">AEGIS v12 :: Voice & Plugins</h1>
                <div class="text-xs mt-3 md:mt-0 space-x-4">
                    <span id="statusBridge" class="diag-warn">BRIDGE: OFFLINE</span>
                    <span id="statusPython" class="diag-warn">PYTHON: OFFLINE</span>
                    <span id="statusVoice" class="diag-warn">VOICE: OFF</span>
                </div>
            </header>

            <div class="glass-panel p-6 flex-grow flex flex-col h-[50vh] lg:h-[70vh]">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">
                    Operational Log <span id="langIndicator" class="text-xs ml-2 opacity-60">EN</span>
                </h2>
                <div id="outputLog" class="flex-grow overflow-y-auto text-sm leading-relaxed p-2" dir="ltr">
                    <p class="mb-2 text-gray-400">[[ AEGIS v12 Initializing... ]]</p>
                </div>
            </div>

            <div class="glass-panel p-4 flex flex-col space-y-4">
                <div class="flex space-x-3">
                    <input type="text" id="inputText" placeholder="Enter command or ask anything..."
                        class="input-cyber flex-grow text-lg" onkeypress="if(event.key==='Enter') AEGIS.executeCommand();">
                    <button id="btnMic" onclick="AEGIS.toggleVoice()"
                        class="bg-purple-600 hover:bg-purple-700 px-4 rounded-lg">
                        üé§
                    </button>
                    <button onclick="AEGIS.executeCommand()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                        Execute
                    </button>
                </div>
                <div class="flex space-x-3 text-xs justify-between">
                    <select id="langSelect" class="input-cyber w-32" onchange="AEGIS.setLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="ur">ÿßÿ±ÿØŸà</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                    <button onclick="AEGIS.listPlugins()" class="bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded-full">
                        üì¶ Plugins
                    </button>
                    <button onclick="AEGIS.reloadPlugins()" class="bg-purple-900 hover:bg-purple-800 py-1 px-3 rounded-full">
                        üîÑ Reload
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 flex flex-col space-y-6">
            
            <div class="glass-panel p-2 flex flex-col items-center justify-center h-64 lg:h-96">
                <h2 class="text-lg font-semibold mb-2 neon-text">3D Interface</h2>
                <canvas id="canvas3d" class="w-full h-full rounded-lg"></canvas>
            </div>

            <div class="glass-panel p-4 flex-grow">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">System Status</h2>
                
                <ul class="text-sm space-y-2">
                    <li class="flex justify-between py-1">
                        <span class="opacity-80">Mode:</span>
                        <span class="diag-good font-mono">EDUCATIONAL</span>
                    </li>
                    <li class="flex justify-between py-1">
                        <span class="opacity-80">Plugins Loaded:</span>
                        <span id="pluginCount" class="diag-good font-mono">0</span>
                    </li>
                    <li class="flex justify-between py-1">
                        <span class="opacity-80">API:</span>
                        <span id="statusAPI" class="diag-good font-mono">GROQ/PROXY</span>
                    </li>
                    <li class="flex justify-between py-1">
                        <span class="opacity-80">Memory Mode:</span>
                        <span class="diag-good font-mono">LIGHTWEIGHT</span>
                    </li>
                </ul>
            </div>
        </div>

    </div>

<script>
const AEGIS = (function() {
    'use strict';

    let ws = null;
    let currentLang = 'en';
    let voiceActive = false;
    let recognition = null;
    let pendingPermission = null;

    const elements = {
        log: document.getElementById('outputLog'),
        input: document.getElementById('inputText'),
        statusBridge: document.getElementById('statusBridge'),
        statusPython: document.getElementById('statusPython'),
        statusVoice: document.getElementById('statusVoice'),
        pluginCount: document.getElementById('pluginCount'),
        langIndicator: document.getElementById('langIndicator'),
        btnMic: document.getElementById('btnMic'),
        permissionModal: document.getElementById('permissionModal'),
        permissionContent: document.getElementById('permissionContent')
    };

    function log(msg, type = 'info') {
        const colors = {
            info: 'text-white',
            success: 'text-green-400',
            error: 'text-red-400',
            warning: 'text-yellow-400',
            system: 'text-blue-400'
        };

        const dir = (currentLang === 'ur' || currentLang === 'ar') ? 'rtl' : 'ltr';
        elements.log.innerHTML += `<p dir="${dir}" class="mb-1 ${colors[type]}">${msg}</p>`;
        elements.log.scrollTop = elements.log.scrollHeight;
    }

    function connectBridge() {
        try {
            ws = new WebSocket('ws://localhost:3000');

            ws.onopen = () => {
                elements.statusBridge.textContent = 'BRIDGE: ONLINE';
                elements.statusBridge.className = 'diag-good';
                log('‚úÖ Connected to AEGIS Bridge', 'success');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'ai_response') {
                        log(`AEGIS: ${data.message}`, 'success');
                        speak(data.message);
                    } else if (data.type === 'python_response') {
                        if (data.data.success) {
                            const msg = data.data.message || JSON.stringify(data.data.data);
                            log(`‚úÖ ${msg}`, 'success');
                        } else {
                            log(`‚ùå ${data.data.message}`, 'error');
                        }
                    } else if (data.type === 'connection') {
                        elements.statusPython.textContent = 'PYTHON: ONLINE';
                        elements.statusPython.className = 'diag-good';
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            ws.onerror = () => {
                elements.statusBridge.textContent = 'BRIDGE: ERROR';
                elements.statusBridge.className = 'diag-critical';
            };

            ws.onclose = () => {
                elements.statusBridge.textContent = 'BRIDGE: OFFLINE';
                elements.statusBridge.className = 'diag-warn';
                log('‚ö†Ô∏è Bridge disconnected. Reconnecting...', 'warning');
                setTimeout(connectBridge, 5000);
            };

        } catch (e) {
            setTimeout(connectBridge, 5000);
        }
    }

    function sendToBridge(type, data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type, ...data }));
        } else {
            log('‚ùå Bridge not connected', 'error');
        }
    }

    function executeCommand() {
        const input = elements.input.value.trim();
        if (!input) return;

        elements.input.value = '';
        log(`USER: ${input}`, 'system');

        const lower = input.toLowerCase();

        // Plugin commands
        if (lower.startsWith('plugin ')) {
            const pluginName = lower.replace('plugin ', '').trim();
            sendToBridge('python_command', {
                command: {
                    action: 'plugin',
                    params: { name: pluginName }
                }
            });
        }
        // System commands
        else if (lower.startsWith('open ')) {
            const app = lower.replace('open ', '').trim();
            sendToBridge('python_command', {
                command: {
                    action: 'open_app',
                    params: { app }
                }
            });
        }
        else if (lower === 'system info') {
            sendToBridge('python_command', {
                command: { action: 'system_info', params: {} }
            });
        }
        else if (lower === 'list plugins') {
            listPlugins();
        }
        // AI query
        else {
            sendToBridge('ai_query', {
                message: input,
                language: currentLang
            });
        }
    }

    function listPlugins() {
        sendToBridge('python_command', {
            command: { action: 'list_plugins', params: {} }
        });
    }

    function reloadPlugins() {
        sendToBridge('python_command', {
            command: { action: 'reload_plugins', params: {} }
        });
    }

    function setLanguage(lang) {
        currentLang = lang;
        elements.langIndicator.textContent = lang.toUpperCase();
        const dir = (lang === 'ur' || lang === 'ar') ? 'rtl' : 'ltr';
        elements.log.dir = dir;
        log(`Language set to ${lang.toUpperCase()}`, 'system');
    }

    function toggleVoice() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            log('‚ùå Voice not supported in this browser', 'error');
            return;
        }

        if (!voiceActive) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                voiceActive = true;
                elements.statusVoice.textContent = 'VOICE: LISTENING';
                elements.statusVoice.className = 'diag-good listening';
                elements.btnMic.classList.add('listening');
                log('üé§ Listening...', 'system');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.input.value = transcript;
                log(`Heard: "${transcript}"`, 'system');
                executeCommand();
            };

            recognition.onend = () => {
                voiceActive = false;
                elements.statusVoice.textContent = 'VOICE: OFF';
                elements.statusVoice.className = 'diag-warn';
                elements.btnMic.classList.remove('listening');
            };

            recognition.onerror = (event) => {
                log(`Voice error: ${event.error}`, 'error');
                voiceActive = false;
            };

            recognition.start();
        } else {
            if (recognition) recognition.stop();
        }
    }

    function speak(text) {
        if (!('speechSynthesis' in window)) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = currentLang === 'ur' ? 'ur-PK' : currentLang === 'ar' ? 'ar-SA' : 'en-US';
        window.speechSynthesis.speak(utterance);
    }

    function requestPermission(action, details) {
        pendingPermission = { action, details };
        elements.permissionContent.innerHTML = `
            <p class="text-lg mb-2"><strong>Action:</strong> ${action}</p>
            <p class="text-sm opacity-80">${details}</p>
        `;
        elements.permissionModal.classList.add('active');
    }

    function approvePermission() {
        if (pendingPermission) {
            log(`‚úÖ Permission granted: ${pendingPermission.action}`, 'success');
            // Execute approved action
        }
        elements.permissionModal.classList.remove('active');
        pendingPermission = null;
    }

    function denyPermission() {
        if (pendingPermission) {
            log(`‚ùå Permission denied: ${pendingPermission.action}`, 'warning');
        }
        elements.permissionModal.classList.remove('active');
        pendingPermission = null;
    }

    function init3D() {
        const canvas = document.getElementById('canvas3d');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);

        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshStandardMaterial({
            color: 0x0ea5e9,
            emissive: 0x002244,
            roughness: 0.1,
            metalness: 0.9
        });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        scene.add(new THREE.AmbientLight(0x404040, 5));
        const light = new THREE.PointLight(0x0ea5e9, 5, 50);
        light.position.set(0, 0, 5);
        scene.add(light);

        camera.position.z = 3;

        function animate() {
            requestAnimationFrame(animate);
            sphere.rotation.x += 0.001;
            sphere.rotation.y += 0.003;
            light.intensity = 5 + Math.sin(Date.now() * 0.002) * 2;
            renderer.render(scene, camera);
        }
        animate();
    }

    function init() {
        log('[[ AEGIS v12 - Voice & Plugin System ]]', 'system');
        log('Educational Research Framework', 'system');
        log('Connecting to bridge...', 'system');
        
        connectBridge();
        init3D();
    }

    window.onload = init;

    return {
        executeCommand,
        listPlugins,
        reloadPlugins,
        setLanguage,
        toggleVoice,
        approvePermission,
        denyPermission
    };
})();
</script>

</body>
</html>
